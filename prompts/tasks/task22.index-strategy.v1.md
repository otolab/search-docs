# task22: LanceDBã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥

## ç›®çš„

search-docsã®LanceDBã«ãŠã‘ã‚‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥ã‚’ç«‹æ¡ˆã—ã€ã‚¯ã‚¨ãƒªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’æœ€é©åŒ–ã™ã‚‹ã€‚

## èƒŒæ™¯

task21ã§statusåˆ—ã«BITMAPã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¿½åŠ ã—ãŸã“ã¨ã§ã€count_rows()ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒåŠ‡çš„ã«æ”¹å–„ã—ãŸï¼ˆ30ç§’ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ â†’ 0.741ç§’ã€ç´„40å€é«˜é€ŸåŒ–ï¼‰ã€‚

ã“ã®æˆåŠŸã‚’å—ã‘ã¦ã€ä»–ã®ã‚«ãƒ©ãƒ ã«ã¤ã„ã¦ã‚‚ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒå¿…è¦ã‹æ¤œè¨ã™ã‚‹ã€‚

## ç¾çŠ¶ã®ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ 

### 1. sections ãƒ†ãƒ¼ãƒ–ãƒ«

```python
- id: string
- document_path: string
- heading: string
- depth: int32
- content: string
- token_count: int32
- vector: list_(float32, 256)  # Vectoræ¤œç´¢ç”¨
- parent_id: string
- order: int32
- is_dirty: bool
- document_hash: string
- created_at: timestamp
- updated_at: timestamp
- start_line: int32
- end_line: int32
- section_number: list_(int32)
```

### 2. index_requests ãƒ†ãƒ¼ãƒ–ãƒ«

```python
- id: string
- document_path: string
- document_hash: string
- status: string  # 'pending', 'processing', 'completed', 'failed', 'skipped'
- created_at: timestamp
- started_at: timestamp
- completed_at: timestamp
- error: string
```

## ã‚¯ã‚¨ãƒªãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æ

### sections ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¯ã‚¨ãƒª

1. **document_pathã§ã®æ¤œç´¢** (é »åº¦: é«˜)
   - `get_sections_by_path()`: `document_path = '...'` ï¼ˆç­‰ä¾¡æ¤œç´¢ï¼‰
   - `find_sections_by_path_and_hash()`: `document_path = '...' AND document_hash = '...'` ï¼ˆç­‰ä¾¡æ¤œç´¢ï¼‰
   - `delete_sections_by_path()`: `document_path = '...'` ï¼ˆç­‰ä¾¡æ¤œç´¢ï¼‰
   - `delete_sections_by_path_except_hash()`: `document_path = '...' AND document_hash != '...'` ï¼ˆç­‰ä¾¡æ¤œç´¢ï¼‰
   - `mark_dirty()`: `document_path = '...'` ï¼ˆç­‰ä¾¡æ¤œç´¢ï¼‰

2. **is_dirtyã§ã®æ¤œç´¢** (é »åº¦: ä¸­)
   - `get_dirty_sections()`: `is_dirty = true`
   - `get_stats()`: `is_dirty = true` (count_rows)
   - `search()`: `is_dirty = false` (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)

3. **IDã§ã®æ¤œç´¢** (é »åº¦: ä½)
   - `get_section_by_id()`: `id = '...'`

4. **Vectoræ¤œç´¢** (é »åº¦: é«˜)
   - `search()`: Vectoré¡ä¼¼åº¦æ¤œç´¢ + ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆdepth, is_dirty, includePaths/excludePathsï¼‰
   - **âš ï¸ å‰æ–¹ä¸€è‡´æ¤œç´¢ï¼ˆtask22ã§è¿½åŠ ï¼‰**:
     - `includePaths`: `document_path LIKE 'path1%' OR document_path LIKE 'path2%'` ï¼ˆORæ¡ä»¶ï¼‰
     - `excludePaths`: `document_path NOT LIKE 'path1%' AND document_path NOT LIKE 'path2%'` ï¼ˆANDæ¡ä»¶ï¼‰

5. **å…¨ä»¶å–å¾—ã§ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°**
   - `get_stats()`: document_pathã®ãƒ¦ãƒ‹ãƒ¼ã‚¯å€¤å–å¾—ï¼ˆSELECT document_pathï¼‰

### index_requests ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¯ã‚¨ãƒª

1. **statusã§ã®æ¤œç´¢** (é »åº¦: é«˜) âœ… **BITMAPã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ æ¸ˆã¿**
   - `find_index_requests()`: `status = '...'` ã¾ãŸã¯ `status IN (...)`
   - `count_index_requests()`: `status = '...'` ã¾ãŸã¯ `status IN (...)`
   - `get_paths_with_status()`: `status IN (...)`

2. **document_pathã§ã®æ¤œç´¢** (é »åº¦: é«˜)
   - `find_index_requests()`: `document_path = '...'` ï¼ˆç­‰ä¾¡æ¤œç´¢ï¼‰
   - `count_index_requests()`: `document_path = '...'` ï¼ˆç­‰ä¾¡æ¤œç´¢ï¼‰
   - `update_many_index_requests()`: `document_path = '...'` ï¼ˆç­‰ä¾¡æ¤œç´¢ï¼‰

3. **document_hashã§ã®æ¤œç´¢** (é »åº¦: ä¸­)
   - `find_index_requests()`: `document_hash = '...'` ï¼ˆç­‰ä¾¡æ¤œç´¢ï¼‰
   - `count_index_requests()`: `document_hash = '...'` ï¼ˆç­‰ä¾¡æ¤œç´¢ï¼‰

4. **IDã§ã®æ¤œç´¢** (é »åº¦: ä½)
   - `update_index_request()`: `id = '...'` ï¼ˆç­‰ä¾¡æ¤œç´¢ï¼‰

5. **è¤‡åˆæ¡ä»¶**
   - `find_index_requests()`: `document_path = '...' AND status = '...'`
   - `find_index_requests()`: `document_hash = '...' AND status = '...'`

## ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æˆ¦ç•¥

### LanceDBã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚¿ã‚¤ãƒ—

1. **BTREE**: ç¯„å›²æ¤œç´¢ã€ã‚½ãƒ¼ãƒˆã€ç­‰ä¾¡æ¤œç´¢ã«æœ‰åŠ¹
2. **BITMAP**: Low-cardinalityï¼ˆãƒ¦ãƒ‹ãƒ¼ã‚¯å€¤ãŒå°‘ãªã„ï¼‰ã‚«ãƒ©ãƒ ã«æœ€é©
3. **LABEL_LIST**: ãƒ©ãƒ™ãƒ«ãƒ‡ãƒ¼ã‚¿å‘ã‘
4. **Vector Index**: Vectoræ¤œç´¢ç”¨ï¼ˆè‡ªå‹•ä½œæˆï¼‰

### æ¨å¥¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

#### index_requests ãƒ†ãƒ¼ãƒ–ãƒ«

1. âœ… **status: BITMAP** (æ—¢å­˜)
   - ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£: 5å€¤ï¼ˆpending, processing, completed, failed, skippedï¼‰
   - é »åº¦: éå¸¸ã«é«˜ã„
   - åŠ¹æœ: å®Ÿè¨¼æ¸ˆã¿ï¼ˆ40å€é«˜é€ŸåŒ–ï¼‰

2. **document_path: BTREE** (æ–°è¦æ¨å¥¨)
   - ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ–‡æ›¸æ•°ã«ä¾å­˜ï¼ˆä¸­ã€œé«˜ï¼‰
   - é »åº¦: é«˜ã„
   - ç†ç”±:
     - `find_index_requests()`ã§é »ç¹ã«ä½¿ç”¨ï¼ˆç­‰ä¾¡æ¤œç´¢ï¼‰
     - statusã¨ã®è¤‡åˆæ¡ä»¶ã‚¯ã‚¨ãƒªã§ã‚‚ä½¿ç”¨
     - ç­‰ä¾¡æ¤œç´¢ã«å¯¾ã—ã¦ã¯ç¢ºå®Ÿã«æœ‰åŠ¹

3. **document_hash: BTREE** (æ–°è¦æ¨å¥¨)
   - ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£: é«˜ã„ï¼ˆå„æ–‡æ›¸ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ä¸€æ„ï¼‰
   - é »åº¦: ä¸­ç¨‹åº¦
   - ç†ç”±:
     - `find_index_requests()`ã€`count_index_requests()`ã§ä½¿ç”¨ï¼ˆç­‰ä¾¡æ¤œç´¢ï¼‰
     - ç­‰ä¾¡æ¤œç´¢ã«å¯¾ã—ã¦ã¯ç¢ºå®Ÿã«æœ‰åŠ¹

4. **id: BTREE** (å„ªå…ˆåº¦: æœ€ä½)
   - ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£: éå¸¸ã«é«˜ã„ï¼ˆUUIDï¼‰
   - é »åº¦: ä½ã„
   - ç†ç”±: ä¸»ã«updateã§ä½¿ç”¨ã€æ¤œç´¢é »åº¦ã¯ä½ã„
   - å‚™è€ƒ: LanceDBã¯primary keyã¨ã—ã¦idã‚’æ‰±ã†ãŸã‚ã€æ—¢ã«æœ€é©åŒ–ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§

#### sections ãƒ†ãƒ¼ãƒ–ãƒ«

1. **document_path: BTREE** (æ–°è¦æ¨å¥¨)
   - ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ–‡æ›¸æ•°ã«ä¾å­˜ï¼ˆä¸­ã€œé«˜ï¼‰
   - é »åº¦: éå¸¸ã«é«˜ã„
   - ç†ç”±:
     - è¤‡æ•°ã®ãƒ¡ã‚½ãƒƒãƒ‰ã§é »ç¹ã«ä½¿ç”¨ï¼ˆç­‰ä¾¡æ¤œç´¢ï¼‰
     - delete, update, selectã®ã‚­ãƒ¼ã¨ã—ã¦ä½¿ç”¨
     - âš ï¸ `search()`ã®includePaths/excludePathsï¼ˆå‰æ–¹ä¸€è‡´æ¤œç´¢ï¼‰ã«ã‚‚ä½¿ç”¨
       - LIKE 'prefix%'ã‚¯ã‚¨ãƒªã¸ã®åŠ¹æœã¯æœªæ¤œè¨¼
       - DataFusionã®min/maxçµ±è¨ˆãƒ™ãƒ¼ã‚¹æœ€é©åŒ–ãŒä½¿ç”¨ã•ã‚Œã‚‹å¯èƒ½æ€§
     - ç­‰ä¾¡æ¤œç´¢ã«å¯¾ã—ã¦ã¯ç¢ºå®Ÿã«æœ‰åŠ¹

2. **is_dirty: BITMAP** (æ–°è¦æ¨å¥¨)
   - ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£: 2å€¤ï¼ˆtrue/falseï¼‰
   - é »åº¦: ä¸­ã€œé«˜
   - ç†ç”±:
     - `get_dirty_sections()`ã§ä½¿ç”¨
     - `get_stats()`ã§count_rows()ã¨å…±ã«ä½¿ç”¨
     - Vectoræ¤œç´¢ã®ãƒ•ã‚£ãƒ«ã‚¿ã¨ã—ã¦ã‚‚ä½¿ç”¨

3. **depth: BITMAP** (å„ªå…ˆåº¦: ä¸­)
   - ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£: 4å€¤ï¼ˆ0, 1, 2, 3ï¼‰
   - é »åº¦: ä¸­
   - ç†ç”±:
     - Vectoræ¤œç´¢ã®ãƒ•ã‚£ãƒ«ã‚¿ã¨ã—ã¦ä½¿ç”¨
     - `depth <= N`ã®ã‚ˆã†ãªç¯„å›²æ¤œç´¢ã‚‚å«ã‚€
   - æ³¨æ„: ç¯„å›²æ¤œç´¢ã‚’å«ã‚€ãŸã‚ã€BITMAPã‚ˆã‚ŠBTREEãŒé©åˆ‡ã‹ã‚‚ã—ã‚Œãªã„

4. **document_hash: BTREE** (å„ªå…ˆåº¦: ä½)
   - ã‚«ãƒ¼ãƒ‡ã‚£ãƒŠãƒªãƒ†ã‚£: é«˜ã„
   - é »åº¦: ä¸­ç¨‹åº¦
   - ç†ç”±: document_pathã¨ã®è¤‡åˆæ¡ä»¶ã§ä½¿ç”¨ã•ã‚Œã‚‹ãŒã€é »åº¦ã¯ä½ã‚

5. **id: BTREE** (å„ªå…ˆåº¦: æœ€ä½)
   - å‚™è€ƒ: primary keyã¨ã—ã¦æ—¢ã«æœ€é©åŒ–ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒé«˜ã„

### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆã®å„ªå…ˆé †ä½

#### Phase 1: é«˜é »åº¦ãƒ»é«˜åŠ¹æœï¼ˆå®Ÿè£…å®Œäº†ï¼‰

1. âœ… `index_requests.status` (BITMAP) - **å®Ÿè£…æ¸ˆã¿**ï¼ˆtask21ï¼‰
2. âœ… `index_requests.document_path` (BTREE) - **å®Ÿè£…æ¸ˆã¿**ï¼ˆtask22ã€ç­‰ä¾¡æ¤œç´¢ã«æœ‰åŠ¹ï¼‰
3. âœ… `index_requests.document_hash` (BTREE) - **å®Ÿè£…æ¸ˆã¿**ï¼ˆtask22ã€ç­‰ä¾¡æ¤œç´¢ã«æœ‰åŠ¹ï¼‰
4. âœ… `sections.document_path` (BTREE) - **å®Ÿè£…æ¸ˆã¿**ï¼ˆtask22ã€ç­‰ä¾¡æ¤œç´¢ã«æœ‰åŠ¹ã€LIKE queryã¯è¦æ¤œè¨¼ï¼‰
5. âœ… `sections.is_dirty` (BITMAP) - **å®Ÿè£…æ¸ˆã¿**ï¼ˆtask22ï¼‰

#### Phase 2: ä¸­é »åº¦ãƒ»ä¸­åŠ¹æœï¼ˆæ§˜å­è¦‹ï¼‰

6. `sections.depth` (BTREE or BITMAP) - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå¾Œã«åˆ¤æ–­

#### Phase 3: ä½é »åº¦ãƒ»åŠ¹æœä¸æ˜ï¼ˆä¿ç•™ï¼‰

7. `sections.document_hash` (BTREE)
8. ãã®ä»–ã®ã‚«ãƒ©ãƒ 

## å®Ÿè£…æ–¹é‡

### 1. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆã‚¿ã‚¤ãƒŸãƒ³ã‚°

- `init_tables()`å†…ã§ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆ
- æ—¢å­˜ã®statusåˆ—ã¨åŒæ§˜ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¸è¥²

### 2. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ¤œè¨¼

- `list_indices()`ã§æ—¢å­˜ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ç¢ºèª
- `hasattr(idx, 'columns')`ã§ã‚«ãƒ©ãƒ ä¸€è‡´ã‚’ç¢ºèª
- é‡è¤‡ä½œæˆã‚’é˜²æ­¢

### 3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®š

- å„ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ å¾Œã€è©²å½“ã‚¯ã‚¨ãƒªã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’æ¸¬å®š
- `explain_plan()`ã§ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½¿ç”¨ã‚’ç¢ºèª
- åŠ¹æœãŒè–„ã„å ´åˆã¯å‰Šé™¤ã‚‚æ¤œè¨

### 4. æ®µéšçš„ãªãƒ­ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆ

- Phase 1ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‹ã‚‰å®Ÿè£…
- æœ¬ç•ªç’°å¢ƒã§åŠ¹æœã‚’ç¢ºèª
- Phase 2ä»¥é™ã¯å¿…è¦ã«å¿œã˜ã¦è¿½åŠ 

## æ³¨æ„äº‹é …

### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ã‚³ã‚¹ãƒˆ

- **ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸**: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡ã‚’æ¶ˆè²»
- **æ›¸ãè¾¼ã¿é€Ÿåº¦**: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒå¤šã„ã¨insert/updateãŒé…ããªã‚‹
- **ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹**: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®å†æ§‹ç¯‰ãŒå¿…è¦ã«ãªã‚‹å ´åˆãŒã‚ã‚‹

### LanceDBã®ç‰¹æ€§

- Vector Indexã¯è‡ªå‹•ã§æœ€é©åŒ–ã•ã‚Œã‚‹
- Scalar Indexã¯æ˜ç¤ºçš„ã«ä½œæˆãŒå¿…è¦
- `count_rows(filter=...)`ã¯è‡ªå‹•çš„ã«Scalar Indexã‚’ä½¿ç”¨

### è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æ¤œè¨

ç¾çŠ¶ã®ã‚¯ã‚¨ãƒªãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã¯å˜ä¸€ã‚«ãƒ©ãƒ ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã§ååˆ†ã ãŒã€ä»¥ä¸‹ã®çµ„ã¿åˆã‚ã›ã¯å°†æ¥çš„ã«æ¤œè¨ä¾¡å€¤ã‚ã‚Šï¼š

- `index_requests (document_path, status)`: è¤‡åˆæ¡ä»¶ã‚¯ã‚¨ãƒªãŒé »ç¹ãªå ´åˆ
- `sections (document_path, is_dirty)`: åŒä¸Š

### å‰æ–¹ä¸€è‡´æ¤œç´¢ï¼ˆLIKE 'prefix%'ï¼‰ã¸ã®å¯¾å¿œ

**task22ã§å®Ÿè£…ã—ãŸå¤‰æ›´**:
- `search()`ãƒ¡ã‚½ãƒƒãƒ‰ã«`includePaths`/`excludePaths`ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ 
- LIKEæ¼”ç®—å­ã«ã‚ˆã‚‹å‰æ–¹ä¸€è‡´æ¤œç´¢ã‚’å®Ÿè£…
  - `includePaths`: `document_path LIKE 'path%'` (ORæ¡ä»¶)
  - `excludePaths`: `document_path NOT LIKE 'path%'` (ANDæ¡ä»¶)

**ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®åŠ¹æœï¼ˆèª¿æŸ»çµæœï¼‰**:

1. **DataFusionï¼ˆLanceDBã®åŸºç›¤ï¼‰ã®æœ€é©åŒ–**:
   - `NOT LIKE 'prefix%'` ã‚¯ã‚¨ãƒªã«å¯¾ã—ã¦min/maxçµ±è¨ˆãƒ™ãƒ¼ã‚¹ã®æœ€é©åŒ–ã‚’æä¾›ï¼ˆDataFusion 46.0.0, 2025å¹´3æœˆï¼‰
   - çµ±è¨ˆæƒ…å ±ã‚’ä½¿ç”¨ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«/ãƒ‘ãƒ¼ãƒ„ã®ã‚¹ã‚­ãƒƒãƒ—ãŒå¯èƒ½

2. **BTREEã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®åŠ¹æœ**:
   - **æœªæ¤œè¨¼**: LanceDBã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€LIKE 'prefix%'ã‚¯ã‚¨ãƒªã«å¯¾ã™ã‚‹BTREEåŠ¹æœã¯æ˜è¨˜ã•ã‚Œã¦ã„ãªã„
   - å¾“æ¥ã®RDBMSï¼ˆPostgreSQLç­‰ï¼‰ã§ã¯ã€BTREE indexãŒ prefix LIKE ã«æœ‰åŠ¹
   - LanceDB/DataFusionã§ã¯çµ±è¨ˆãƒ™ãƒ¼ã‚¹ã®ãƒ—ãƒ«ãƒ¼ãƒ‹ãƒ³ã‚°ãŒä¸»æµ

3. **æ¨å¥¨ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ**:
   - BTREEã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯ç­‰ä¾¡æ¤œç´¢ã«å¯¾ã—ã¦ã¯ç¢ºå®Ÿã«æœ‰åŠ¹
   - LIKE queryã¸ã®åŠ¹æœã¯å®Ÿè£…å¾Œã«ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã§æ¤œè¨¼ã™ã¹ã
   - åŠ¹æœãŒè–„ã„å ´åˆã§ã‚‚ã€ç­‰ä¾¡æ¤œç´¢ã®é«˜é€ŸåŒ–ã®ãŸã‚ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯æ¨å¥¨

## å®Ÿè£…çµæœ

### Phase 1: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆï¼ˆå®Œäº†ï¼‰

ã™ã¹ã¦ã®Phase 1æ¨å¥¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å®Ÿè£…ã—ã¾ã—ãŸ:

**index_requestsãƒ†ãƒ¼ãƒ–ãƒ«**:
1. âœ… `status` (BITMAP) - æ—¢å­˜ï¼ˆtask21ã§å®Ÿè£…ï¼‰
2. âœ… `document_path` (BTREE) - æ–°è¦ä½œæˆå®Œäº†
3. âœ… `document_hash` (BTREE) - æ–°è¦ä½œæˆå®Œäº†

**sectionsãƒ†ãƒ¼ãƒ–ãƒ«**:
1. âœ… `document_path` (BTREE) - æ–°è¦ä½œæˆå®Œäº†
2. âœ… `is_dirty` (BITMAP) - æ–°è¦ä½œæˆå®Œäº†

### å®Ÿè£…ã®è©³ç´°

**worker.py**:
- `wait_for_index()`ã®æ­£ã—ã„ä½¿ç”¨æ–¹æ³•ã‚’é©ç”¨
  - ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åãƒªã‚¹ãƒˆã‚’æ¸¡ã™: `["column_name_idx"]`
  - ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¯`timedelta(seconds=60)`
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’å„ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã”ã¨ã«å®Ÿè£…

**ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å‘½åè¦å‰‡**:
- LanceDBã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: `{column_name}_idx`
- ä¾‹: `document_path` â†’ `document_path_idx`

### å‰æ–¹ä¸€è‡´æ¤œç´¢ã®å‹•ä½œç¢ºèª

**ãƒ†ã‚¹ãƒˆå®Ÿæ–½æ—¥**: 2025-11-07

1. **includePathså‹•ä½œç¢ºèª**:
   ```
   ã‚¯ã‚¨ãƒª: "ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£"
   includePaths: ["docs/"]
   çµæœ: ã™ã¹ã¦ docs/ é…ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ« âœ…
   ```

2. **excludePathså‹•ä½œç¢ºèª**:
   ```
   ã‚¯ã‚¨ãƒª: "ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£"
   excludePaths: ["docs/"]
   çµæœ: docs/ é…ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒé™¤å¤–ã•ã‚Œã‚‹ âœ…
   ```

3. **è¤‡åˆæ¡ä»¶å‹•ä½œç¢ºèª**:
   ```
   ã‚¯ã‚¨ãƒª: "æ¤œç´¢"
   includePaths: ["prompts/"]
   excludePaths: ["prompts/tasks/"]
   çµæœ: prompts/ é…ä¸‹ã‹ã¤ prompts/tasks/ é™¤å¤– âœ…
   ```

### ãƒã‚°ãƒ•ã‚£ãƒƒã‚¯ã‚¹

**SearchDocsServer.search()ã®excludePathså‡¦ç†**:
- å•é¡Œ: ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®šã®`excludePaths`ãŒ`indexStatus`ã«ã‚ˆã‚‹è‡ªå‹•é™¤å¤–ãƒ‘ã‚¹ã§ä¸Šæ›¸ãã•ã‚Œã¦ã„ãŸ
- ä¿®æ­£: ä¸¡æ–¹ã‚’ãƒãƒ¼ã‚¸ã—ã¦é©ç”¨ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´
  ```typescript
  const mergedExcludePaths = [
    ...(request.options?.excludePaths || []),
    ...(autoExcludePaths || []),
  ];
  ```

### æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. âœ… Phase 1ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å®Ÿè£…å®Œäº†
2. ğŸ”œ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã‚’å®Ÿæ–½ï¼ˆå°†æ¥ã®ã‚¿ã‚¹ã‚¯ï¼‰
   - ç­‰ä¾¡æ¤œç´¢ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®š
   - **LIKE 'prefix%'ã‚¯ã‚¨ãƒªã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®šï¼ˆé‡è¦ï¼‰**
3. ğŸ”œ åŠ¹æœæ¸¬å®šã¨æ–‡æ›¸åŒ–
4. â¸ï¸ å¿…è¦ã«å¿œã˜ã¦Phase 2ã¸é€²ã‚€ï¼ˆæ§˜å­è¦‹ï¼‰

## å‚è€ƒ

- task21.2: count_rows()ã¨BITMAPã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«ã‚ˆã‚‹é«˜é€ŸåŒ–
- task22: search()ã¸ã®å‰æ–¹ä¸€è‡´æ¤œç´¢ï¼ˆincludePaths/excludePathsï¼‰è¿½åŠ 
- LanceDB Documentation: https://lancedb.github.io/lancedb/indexing/
- DataFusion 46.0.0 (2025/03): NOT LIKE prefix optimization
  - https://datafusion.apache.org/blog/2025/03/24/datafusion-46.0.0/
