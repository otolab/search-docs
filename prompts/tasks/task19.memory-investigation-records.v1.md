# task19: メモリ増加調査の記録

## 目的

large-test-projectプロジェクト（102,893 Markdownファイル）で観測されたPythonプロセスのメモリ増加について、測定記録を時系列で保存する。

## 記録の原則

- **FACTS（思い込みが含まれている可能性がある）**: 実際に測定・観測された生データのみ記録
- 解釈や推測は含めない
- 後から検証可能な形式で保存

---

## 測定記録

### 記録1: フレッシュスタート測定（1秒間隔）

**測定日時**: 2025-11-05
**測定対象**: large-test-projectプロジェクト（102,893 Markdownファイル）
**測定方法**: 1秒間隔でPID監視
**ログファイル**: `/tmp/memory-fresh-start.log`

```
Monitoring PID 20081 for 300s (1s interval)
Time(s), RSS(MB), VSZ(MB), Threads
0, 863.30, 406952.00, 31
1, 882.95, 407464.00, 31
2, 900.14, 407464.00, 31
3, 915.28, 407464.00, 31
4, 931.50, 407464.00, 31
5, 946.88, 407466.00, 32
6, 964.94, 407466.00, 32
7, 985.25, 407978.00, 32
8, 997.34, 407978.00, 32
10, 1010.75, 407978.00, 32
11, 1029.77, 407978.00, 32
12, 1039.97, 407979.00, 32
13, 1059.02, 407987.00, 32
14, 1071.38, 407987.00, 32
15, 1082.80, 407989.00, 33
16, 1104.16, 408501.00, 33
17, 1117.73, 408501.00, 33
18, 1129.30, 408501.00, 33
19, 1142.55, 408503.00, 34
20, 1155.64, 408503.00, 34
21, 2542.44, 411751.00, 63
22, 2786.73, 413900.00, 64
23, 2854.73, 413900.00, 64
24, 2882.33, 413902.00, 64
25, 2919.72, 413910.00, 64
26, 2952.05, 411540.00, 69
27, 2982.89, 411434.00, 69
28, 3008.16, 411527.00, 69
29, 3054.56, 411553.00, 69
30, 3065.86, 412043.00, 69
31, 3104.12, 412051.00, 69
32, 3116.80, 412073.00, 68
33, 3145.05, 412044.00, 85
34, 3188.78, 412089.00, 86
36, 3415.12, 412534.00, 86
37, 3487.52, 412614.00, 86
38, 3515.14, 412628.00, 86
39, 3547.28, 412652.00, 86
40, 3609.78, 412694.00, 86
41, 3729.42, 413388.00, 86
42, 3765.61, 413501.00, 86
43, 3814.11, 413527.00, 86
44, 3857.83, 413555.00, 91
45, 3907.08, 414085.00, 91
46, 3923.62, 413429.00, 91
47, 4001.45, 413478.00, 91
48, 4027.92, 413502.00, 91
49, 4055.61, 413502.00, 91
50, 4095.52, 414040.00, 91
51, 4134.78, 414059.00, 91
52, 4159.00, 414072.00, 93
53, 4165.91, 413996.00, 93
54, 4198.70, 413708.00, 93
55, 4209.03, 415304.00, 93
56, 4279.27, 415967.00, 93
57, 4315.98, 415996.00, 93
59, 4367.94, 416111.00, 93
60, 4388.55, 416111.00, 93
61, 4396.72, 415018.00, 97
62, 4403.73, 415499.00, 97
63, 4411.78, 415459.00, 97
64, 4448.78, 415380.00, 97
65, 4466.30, 415472.00, 97
66, 4488.09, 415480.00, 97
67, 4609.16, 415570.00, 97
68, 4746.38, 416098.00, 97
69, 5793.00, 421236.00, 97
70, 5935.06, 421839.00, 97
71, 5985.69, 421986.00, 97
72, 6014.42, 422516.00, 97
73, 6056.36, 422334.00, 97
74, 6094.97, 422356.00, 97
75, 6126.30, 422278.00, 97
76, 6135.48, 422288.00, 97
77, 6140.98, 420044.00, 97
78, 6149.06, 420276.00, 97
79, 6161.77, 420164.00, 97
81, 6179.72, 420192.00, 97
82, 6206.80, 420692.00, 97
83, 6214.06, 420692.00, 97
84, 6252.97, 421380.00, 97
85, 6276.34, 421280.00, 97
86, 6289.61, 421293.00, 97
87, 6299.06, 421395.00, 97
88, 6325.69, 421427.00, 97
89, 6339.48, 420750.00, 98
90, 6347.67, 423938.00, 98
91, 6407.22, 423969.00, 98
92, 6451.41, 424136.00, 98
93, 6478.81, 424145.00, 98
94, 6485.09, 424148.00, 98
95, 6501.38, 422016.00, 98
96, 6735.06, 423165.00, 99
97, 6753.33, 423174.00, 99
98, 6766.70, 423184.00, 99
99, 6782.16, 423184.00, 99
100, 6808.92, 422944.00, 99
101, 6826.39, 425456.00, 99
102, 6850.95, 425546.00, 99
103, 6867.16, 425542.00, 99
104, 6888.34, 425870.00, 99
105, 6912.67, 426400.00, 107
107, 6920.12, 424622.00, 107
108, 6934.42, 424731.00, 107
109, 6951.81, 424739.00, 107
110, 6992.06, 425080.00, 107
111, 6995.61, 425082.00, 107
112, 7002.83, 425734.00, 107
113, 7022.47, 425742.00, 107
114, 7025.31, 425742.00, 107
115, 7028.27, 428192.00, 107
116, 7077.62, 428914.00, 107
117, 7089.09, 428218.00, 107
118, 7096.17, 428166.00, 107
119, 7104.45, 428954.00, 107
120, 7145.39, 428962.00, 107
121, 7168.62, 427124.00, 107
122, 7181.03, 427122.00, 107
123, 7212.83, 427212.00, 107
124, 7216.98, 429260.00, 107
125, 7254.70, 429206.00, 107
126, 7268.31, 429009.00, 107
127, 7287.42, 429530.00, 107
128, 7290.86, 428690.00, 107
129, 7293.16, 428690.00, 107
130, 7298.64, 426548.00, 107
131, 7309.44, 426550.00, 107
132, 7325.14, 426588.00, 107
133, 7336.72, 426661.00, 107
134, 7353.06, 426761.00, 107
135, 7362.23, 426761.00, 107
136, 7366.75, 426764.00, 107
137, 7368.53, 426720.00, 107
138, 7373.89, 426652.00, 107
140, 7390.59, 426580.00, 106
141, 7406.61, 426580.00, 106
142, 7418.89, 426602.00, 106
143, 7424.67, 426603.00, 106
144, 7433.97, 426611.00, 106
145, 7443.77, 426611.00, 106
146, 7448.84, 426611.00, 106
147, 7451.38, 426611.00, 106
148, 7457.73, 426619.00, 106
149, 7458.61, 426587.00, 106
150, 7467.16, 427139.00, 106
151, 7483.80, 427539.00, 106
152, 7517.55, 427555.00, 106
153, 7522.20, 427555.00, 106
154, 7528.44, 427555.00, 106
Process 20081 terminated
```

**測定終了理由**: プロセス終了

---

### 記録2: 詳細測定（PID 5597）

**測定日時**: 2025-11-05
**測定対象**: 同上
**測定方法**: 1秒間隔でPID監視
**ログファイル**: `/tmp/memory-detailed-5597.log`

```
Monitoring PID 5597 for 180s (1s interval)
Time(s), RSS(MB), VSZ(MB), Threads
0, 4322.03, 416263.00, 125
1, 4330.78, 416263.00, 125
2, 4340.69, 416277.00, 125
3, 4345.89, 416282.00, 125
4, 4345.92, 416214.00, 124
5, 4346.08, 416202.00, 124
6, 4346.19, 416190.00, 124
7, 4346.28, 416190.00, 124
8, 4348.53, 416206.00, 124
9, 4348.53, 416174.00, 124
10, 4349.53, 416174.00, 124
11, 4350.94, 416238.00, 124
12, 4462.36, 417033.00, 124
13, 4480.20, 417042.00, 124
14, 4499.98, 417051.00, 124
15, 4503.38, 417051.00, 124
16, 4520.09, 417075.00, 124
17, 4528.95, 417007.00, 124
19, 4550.58, 417016.00, 124
20, 4554.78, 416986.00, 124
21, 4554.89, 416986.00, 124
22, 4555.00, 416878.00, 124
23, 4555.08, 416854.00, 124
24, 4659.09, 417188.00, 124
25, 4696.72, 417222.00, 124
26, 5269.64, 418835.00, 124
27, 5290.77, 418851.00, 124
28, 5311.84, 418860.00, 124
29, 5343.55, 418870.00, 126
30, 5354.80, 418879.00, 126
31, 5355.19, 418311.00, 126
32, 5473.33, 418643.00, 126
33, 5497.61, 418653.00, 126
34, 5527.52, 418668.00, 125
35, 5532.67, 418670.00, 125
36, 5532.94, 418638.00, 125
37, 5533.05, 418310.00, 125
38, 5533.16, 418310.00, 125
39, 5533.22, 418194.00, 125
40, 5546.33, 418824.00, 125
41, 5557.48, 418824.00, 125
42, 5570.52, 418824.00, 125
43, 5574.02, 419008.00, 125
44, 5600.50, 419018.00, 125
45, 5630.05, 419009.00, 125
46, 5633.42, 419009.00, 125
47, 5661.39, 419085.00, 125
48, 5664.48, 418993.00, 125
49, 5677.19, 418993.00, 125
51, 5698.91, 419562.00, 125
52, 5704.12, 419565.00, 125
53, 5705.09, 419474.00, 124
54, 5705.17, 419474.00, 124
55, 5705.30, 419474.00, 124
56, 5705.38, 419298.00, 124
57, 5823.05, 419679.00, 125
58, 5853.92, 419728.00, 125
59, 5854.16, 419728.00, 125
60, 5856.95, 419696.00, 125
61, 5876.53, 419800.00, 125
62, 5882.28, 419686.00, 125
63, 5889.38, 419680.00, 125
64, 5905.25, 420152.00, 125
65, 5911.94, 420152.00, 125
66, 5915.03, 420153.00, 126
67, 5917.30, 420039.00, 126
68, 5919.81, 420008.00, 126
69, 5919.89, 419458.00, 126
70, 5920.02, 419458.00, 126
71, 5920.06, 419457.00, 125
72, 5923.70, 419491.00, 125
73, 5925.59, 419491.00, 125
74, 5927.42, 419491.00, 125
75, 5932.44, 419499.00, 125
76, 5935.11, 419499.00, 125
77, 5940.03, 419497.00, 125
79, 5940.34, 419465.00, 125
80, 5942.36, 419465.00, 125
81, 5965.12, 419619.00, 125
82, 5969.05, 419622.00, 125
83, 5969.12, 419590.00, 125
84, 5969.22, 419590.00, 125
85, 5969.31, 419590.00, 125
86, 5969.41, 419484.00, 125
87, 5980.30, 419534.00, 125
88, 5997.23, 420086.00, 125
89, 6000.73, 420086.00, 125
90, 6003.64, 420086.00, 125
91, 6034.44, 420455.00, 125
92, 6039.56, 420455.00, 125
93, 6048.44, 420415.00, 125
94, 6055.83, 420384.00, 125
95, 6056.08, 420384.00, 125
96, 6056.17, 420030.00, 125
97, 6056.23, 420030.00, 124
98, 6056.44, 420028.00, 124
99, 6062.42, 420046.00, 124
100, 6062.47, 420014.00, 124
101, 6063.30, 420014.00, 124
102, 6065.05, 420046.00, 124
103, 6073.36, 420062.00, 124
104, 6076.00, 420062.00, 124
105, 6082.92, 420046.00, 124
106, 6104.97, 420096.00, 124
108, 6105.72, 420096.00, 125
109, 6105.72, 420064.00, 125
110, 6105.83, 420064.00, 125
111, 6105.83, 420064.00, 125
112, 6105.83, 420036.00, 125
113, 6105.83, 420036.00, 125
114, 6105.83, 420036.00, 125
115, 6105.88, 420036.00, 125
116, 6105.88, 420036.00, 125
117, 6105.88, 420036.00, 125
118, 6105.88, 420036.00, 125
119, 6105.88, 420036.00, 125
120, 6105.91, 420036.00, 125
121, 6105.91, 420036.00, 125
122, 6105.91, 420036.00, 125
123, 6105.91, 420036.00, 125
124, 6105.91, 420036.00, 125
125, 6105.91, 420036.00, 125
126, 6105.91, 420036.00, 125
127, 6105.91, 420036.00, 125
128, 6105.91, 420036.00, 125
129, 6105.92, 420036.00, 125
131, 6105.92, 420036.00, 125
132, 6105.92, 420036.00, 125
133, 6105.92, 420036.00, 125
134, 6105.92, 420036.00, 125
135, 6105.94, 420036.00, 125
136, 6105.94, 420036.00, 125
137, 6105.94, 420036.00, 125
138, 6105.94, 420036.00, 125
139, 6105.94, 420036.00, 125
140, 6105.95, 420036.00, 125
141, 6105.95, 420036.00, 125
142, 6105.95, 420036.00, 125
143, 6105.95, 420036.00, 125
144, 6105.95, 420036.00, 125
145, 6105.95, 420036.00, 125
146, 6105.95, 420036.00, 125
147, 6105.95, 420036.00, 125
148, 6105.95, 420036.00, 125
149, 6105.95, 420036.00, 125
150, 6105.97, 420036.00, 125
151, 6105.97, 420036.00, 125
152, 6105.97, 420036.00, 125
153, 6105.97, 420036.00, 125
154, 6105.97, 420036.00, 125
155, 6105.97, 420036.00, 125
157, 6105.97, 420036.00, 125
158, 6105.97, 420036.00, 125
159, 6105.97, 420036.00, 125
160, 6106.06, 420036.00, 125
161, 6106.06, 420036.00, 125
162, 6106.06, 420036.00, 125
163, 6106.06, 420036.00, 125
164, 6106.06, 420036.00, 125
165, 6106.06, 420036.00, 125
166, 6106.06, 420036.00, 125
167, 6106.06, 420036.00, 125
168, 6106.06, 420036.00, 125
169, 6106.06, 420036.00, 125
170, 6106.06, 420036.00, 125
171, 6106.06, 420036.00, 125
172, 6106.06, 420036.00, 125
173, 6106.06, 420036.00, 125
174, 6106.06, 420036.00, 125
175, 6106.06, 420036.00, 125
176, 6106.06, 420036.00, 125
177, 6106.06, 420036.00, 125
178, 6106.06, 420036.00, 125
179, 6106.06, 420036.00, 125
```

**測定終了理由**: 180秒経過（設定された制限時間）

---

### 記録3: サーバ起動ログ

**ログファイル**: `/tmp/server-start.log`

```
[DEBUG] executeServerStart options: {}
Server start requested
Loading configuration...
Project root: /path/to/large-test-project
Config: /path/to/large-test-project/.search-docs.json
Log file: /path/to/large-test-project/.search-docs/server.log
Checking for existing server...
Checking port 53567...
Port 53567 is available
Resolving server script path...
Server script: /Users/naoto.kato/Develop/otolab/search-docs/packages/server/dist/bin/server.js
Starting server (daemon mode)...
Server process spawned (PID: 20072)
Waiting for server to start...
ERROR: Server startup timeout. Check logs for details.

Check log file for details: /path/to/large-test-project/.search-docs/server.log
Error: Server startup timeout. Check logs for details.
```

---

### 記録4: コード構造

**ファイル**: `/Users/naoto.kato/Develop/otolab/search-docs/packages/server/src/worker/index-worker.ts`

**該当箇所（Line 104-106）**:
```typescript
for (const request of requests) {
  await this.processRequest(request);
}
```

**該当箇所（Line 232-236）**:
```typescript
await this.dbEngine.addSections(sections);
console.log(`[IndexWorker] Created ${sections.length} sections for ${request.documentPath}`);

// LanceDBの書き込み完了を待つ（100ms）
await new Promise(resolve => setTimeout(resolve, 100));
```

**ファイル**: `/Users/naoto.kato/Develop/otolab/search-docs/packages/db-engine/src/python/worker.py`

**該当箇所（スレッド制限設定）**:
```python
# スレッド数を制限（メモリ使用量削減）
os.environ['OMP_NUM_THREADS'] = '4'
os.environ['MKL_NUM_THREADS'] = '4'
os.environ['NUMEXPR_NUM_THREADS'] = '4'
os.environ['OPENBLAS_NUM_THREADS'] = '4'

# PyArrowメモリプールを system (malloc) に変更
pa.set_memory_pool(pa.system_memory_pool())
```

**該当箇所（add_sections with compact）**:
```python
def add_sections(self, params: Dict[str, Any]) -> Dict[str, int]:
    # ... 処理 ...

    # 一括追加
    table = self._get_sections_table()
    table.add(sections)

    # メモリリーク対策: GCを明示的に実行
    count = len(sections)
    gc.collect()

    # 呼び出し回数をカウント
    self._add_count += 1

    # 100回ごとにcompact実行（断片化防止）
    if self._add_count % 100 == 0:
        try:
            sys.stderr.write(f"Compacting table (add_count={self._add_count})...\n")
            table.optimize.compact_files()
            gc.collect()
            sys.stderr.write(f"Compaction completed\n")
        except Exception as e:
            sys.stderr.write(f"Warning: Compaction failed: {e}\n")

    return {"count": count}
```

---

## ユニットテスト結果

**テストファイル**: `/Users/naoto.kato/Develop/otolab/search-docs/packages/db-engine/src/python/__tests__/test_memory_leak.py`

**実行コマンド**: `uv run pytest src/python/__tests__/test_memory_leak.py -v`

**結果**: 全てPASSED

```
test_add_sections_object_leak_1_vs_10 PASSED
test_search_object_leak_1_vs_10 PASSED
test_get_stats_object_leak_1_vs_10 PASSED
test_add_sections_object_leak_100_iterations PASSED
test_search_object_leak_1000_iterations PASSED
test_get_stats_object_leak_1000_iterations PASSED
test_lancedb_external_object_leak PASSED
test_transformers_external_object_leak PASSED
```

---

## ユーザーからの観察（引用）

1. "メモリプレッシャーが強くなってから使用量が下がる動きも観察できました"
2. "リニアに増えていない。急に大きく上昇する"
3. "いまはスレッドの数に比例している感じがする"
4. "addをまとめるように言ったつもりだったんだけど。"

---

## 実施した対策の記録

### 対策1: PyArrowメモリプール変更
**実施日**: 2025-11-05
**コード変更**: `pa.set_memory_pool(pa.system_memory_pool())`
**測定結果**: 記録1と記録2を参照

### 対策2: 100ms wait追加
**実施日**: 2025-11-05
**コード変更**: `await new Promise(resolve => setTimeout(resolve, 100));`
**測定結果**: 記録1を参照

### 対策3: スレッド数制限
**実施日**: 2025-11-05
**コード変更**: `os.environ['OMP_NUM_THREADS'] = '4'` など
**測定結果**: 記録1でスレッド数97、記録2でスレッド数125を観測

### 対策4: 100回ごとにcompact_files()実行
**実施日**: 2025-11-05
**コード変更**: `if self._add_count % 100 == 0: table.optimize.compact_files()`
**測定結果**: 効果未測定

---

## 不明な点・未測定の項目

- LanceDBのFragment数（実測値なし）
- add_sections()の実際の呼び出し回数（推定のみ）
- TypeScriptプロセスのメモリ使用量
- スレッド生成元の特定
- compact_files()の効果
- 100ms waitの効果の統計的検証

---

## 次の検証候補

1. LanceDB Fragment数の確認
2. add_sections()呼び出し回数のログ出力
3. TypeScriptプロセスのメモリ監視
4. スレッドダンプによる生成元特定
5. add_sections()のバッチ化実装と効果測定
