# Task 4: CLIæ®‹ã‚Šã®ã‚³ãƒãƒ³ãƒ‰å®Ÿè£… - å®Œäº†å ±å‘Š

> **ğŸ”’ ã“ã®æ–‡ç« ã¯FIXEDã§ã™ (2025-11-04)**
> ä»¥é™ã®ä¿®æ­£ã¯æ³¨é‡ˆè¿½è¨˜ã®ã¿è¨±å¯ã•ã‚Œã¾ã™

**ä½œæˆæ—¥**: 2025-10-28
**å®Œäº†æ—¥**: 2025-10-29
**ã‚¿ã‚¹ã‚¯ç•ªå·**: task4
**çŠ¶æ…‹**: éƒ¨åˆ†å®Œäº†ï¼ˆPhase 3å®Œäº†ã€Phase 4/5ã¯éƒ¨åˆ†å®Ÿè£…ï¼‰

## æ¦‚è¦

search-docs CLIãƒ„ãƒ¼ãƒ«ã®æ®‹ã‚Šã®ã‚³ãƒãƒ³ãƒ‰ï¼ˆserver, index, configï¼‰ã®å®Ÿè£…ã‚’è¨ˆç”»ã€‚
**Phase 3ï¼ˆserverã‚³ãƒãƒ³ãƒ‰ï¼‰ã¯å®Œå…¨ã«å®Ÿè£…å®Œäº†**ã€‚Phase 4/5ã¯éƒ¨åˆ†å®Ÿè£…ã€‚

## å®Ÿè£…å®Œäº†é …ç›®

### âœ… Phase 3: serverã‚³ãƒãƒ³ãƒ‰ï¼ˆå®Œäº†ï¼‰

ã™ã¹ã¦ã®serverã‚³ãƒãƒ³ãƒ‰ãŒå®Ÿè£…ã•ã‚Œã€å‹•ä½œç¢ºèªæ¸ˆã¿ã€‚

#### å®Ÿè£…æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«
- `packages/cli/src/commands/server/start.ts` - ã‚µãƒ¼ãƒèµ·å‹•ï¼ˆãƒ‡ãƒ¼ãƒ¢ãƒ³å¯¾å¿œï¼‰
- `packages/cli/src/commands/server/stop.ts` - ã‚µãƒ¼ãƒåœæ­¢
- `packages/cli/src/commands/server/status.ts` - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
- `packages/cli/src/commands/server/restart.ts` - ã‚µãƒ¼ãƒå†èµ·å‹•

#### å®Ÿè£…ã•ã‚ŒãŸæ©Ÿèƒ½
- âœ… server startï¼ˆãƒ‡ãƒ¼ãƒ¢ãƒ³èµ·å‹•å¯¾å¿œï¼‰
  - PIDãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ï¼ˆ`.search-docs/server.pid`ï¼‰
  - è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
  - ãƒãƒ¼ãƒˆæŒ‡å®šãƒ»ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«å¯¾å¿œ
  - ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰èµ·å‹•ï¼ˆ--daemonï¼‰
- âœ… server stop
  - PIDãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ—ãƒ­ã‚»ã‚¹IDèª­ã¿è¾¼ã¿
  - SIGTERM/SIGKILLã«ã‚ˆã‚‹åœæ­¢
  - PIDãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
- âœ… server status
  - ãƒ—ãƒ­ã‚»ã‚¹ç”Ÿå­˜ç¢ºèª
  - ã‚µãƒ¼ãƒæƒ…å ±è¡¨ç¤ºï¼ˆPIDã€ãƒãƒ¼ãƒˆã€èµ·å‹•æ™‚åˆ»ï¼‰
- âœ… server restart
  - stop + start ã®çµ„ã¿åˆã‚ã›

#### ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£å®Ÿè£…
- `packages/cli/src/utils/process.ts` - ãƒ—ãƒ­ã‚»ã‚¹ç®¡ç†
- `packages/cli/src/utils/pid.ts` - PIDãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†

### âš ï¸ Phase 4: indexã‚³ãƒãƒ³ãƒ‰ï¼ˆéƒ¨åˆ†å®Œäº†ï¼‰

#### å®Ÿè£…æ¸ˆã¿
- âœ… `index rebuild` - packages/cli/src/commands/index/rebuild.ts
  - ã‚µãƒ¼ãƒã®rebuildIndex APIã‚’å‘¼ã³å‡ºã—
  - é€²æ—è¡¨ç¤º
  - æŒ‡å®šãƒ‘ã‚¹ã®ã¿å†æ§‹ç¯‰

#### æœªå®Ÿè£…
- âŒ `index status` - ã‚¹ã‚¿ãƒ–ã®ã¿ï¼ˆ"index status: æœªå®Ÿè£…"ï¼‰
- âŒ `index clean` - ã‚¹ã‚¿ãƒ–ã®ã¿ï¼ˆ"index clean: æœªå®Ÿè£…"ï¼‰

### âŒ Phase 5: configã‚³ãƒãƒ³ãƒ‰ï¼ˆæœªå®Ÿè£…ï¼‰

ã™ã¹ã¦æœªå®Ÿè£…ï¼ˆã‚¹ã‚¿ãƒ–ã®ã¿ï¼‰ï¼š
- âŒ `config init` - ã‚¹ã‚¿ãƒ–ã®ã¿ï¼ˆ"config init: æœªå®Ÿè£…"ï¼‰
- âŒ `config validate` - ã‚¹ã‚¿ãƒ–ã®ã¿ï¼ˆ"config validate: æœªå®Ÿè£…"ï¼‰
- âŒ `config show` - ã‚¹ã‚¿ãƒ–ã®ã¿ï¼ˆ"config show: æœªå®Ÿè£…"ï¼‰

## ãƒ†ã‚¹ãƒˆçŠ¶æ³

### E2Eãƒ†ã‚¹ãƒˆ
- âœ… ã‚µãƒ¼ãƒèµ·å‹•ãƒ»åœæ­¢ãƒ»æ¤œç´¢ã®çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆpackages/cli/__tests__/e2e.test.tsï¼‰
- âœ… TEST_VERBOSEç’°å¢ƒå¤‰æ•°ã«ã‚ˆã‚‹å‡ºåŠ›åˆ¶å¾¡

### å‹•ä½œç¢ºèª
ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã¯å®Ÿéš›ã«å‹•ä½œç¢ºèªæ¸ˆã¿ï¼š
```bash
# ã‚µãƒ¼ãƒèµ·å‹•
node packages/cli/dist/index.js server start --daemon

# ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
node packages/cli/dist/index.js server status

# æ¤œç´¢
node packages/cli/dist/index.js search "æ¤œç´¢ã‚¯ã‚¨ãƒª"

# ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å†æ§‹ç¯‰
node packages/cli/dist/index.js index rebuild AGENTS.md

# ã‚µãƒ¼ãƒåœæ­¢
node packages/cli/dist/index.js server stop
```

## å®Œäº†åŸºæº–ã®é”æˆçŠ¶æ³

### Phase 3: serverã‚³ãƒãƒ³ãƒ‰ âœ…
- âœ… server start ãŒå‹•ä½œã™ã‚‹
- âœ… server stop ãŒå‹•ä½œã™ã‚‹
- âœ… server status ãŒå‹•ä½œã™ã‚‹
- âœ… server restart ãŒå‹•ä½œã™ã‚‹
- âœ… ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆé€šé

### Phase 4: indexã‚³ãƒãƒ³ãƒ‰ âš ï¸
- âœ… index rebuild ãŒå‹•ä½œã™ã‚‹
- âŒ index status ãŒå‹•ä½œã™ã‚‹
- âŒ index clean ãŒå‹•ä½œã™ã‚‹
- âš ï¸ ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆï¼ˆéƒ¨åˆ†çš„ï¼‰

### Phase 5: configã‚³ãƒãƒ³ãƒ‰ âŒ
- âŒ config init ãŒå‹•ä½œã™ã‚‹
- âŒ config validate ãŒå‹•ä½œã™ã‚‹
- âŒ config show ãŒå‹•ä½œã™ã‚‹
- âŒ ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆé€šé

### å…¨ä½“ âš ï¸
- âœ… å…¨ã‚³ãƒãƒ³ãƒ‰ãŒãƒ“ãƒ«ãƒ‰æˆåŠŸ
- âœ… å®Ÿè£…æ¸ˆã¿ã‚³ãƒãƒ³ãƒ‰ã®ãƒ†ã‚¹ãƒˆé€šé
- âœ… å‹ãƒã‚§ãƒƒã‚¯ãƒ»linté€šé
- âœ… E2Eãƒ†ã‚¹ãƒˆæ‹¡å¼µ
- âš ï¸ READMEæ›´æ–°ï¼ˆéƒ¨åˆ†çš„ï¼‰

## å®Ÿè£…ã®è©³ç´°

### ãƒ—ãƒ­ã‚»ã‚¹ç®¡ç†ï¼ˆpackages/cli/src/utils/process.tsï¼‰

ãƒ‡ãƒ¼ãƒ¢ãƒ³åŒ–ã®å®Ÿè£…ï¼š
```typescript
// ãƒ‡ãƒ¼ãƒ¢ãƒ³èµ·å‹•
const child = spawn('node', [serverScript], {
  detached: true,     // è¦ªã‹ã‚‰åˆ‡ã‚Šé›¢ã™
  stdio: ['ignore', logFd, logFd],  // stdout/stderrã‚’ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã¸
});
child.unref();        // è¦ªãƒ—ãƒ­ã‚»ã‚¹çµ‚äº†ã‚’å¾…ãŸãªã„
```

### PIDãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ï¼ˆpackages/cli/src/utils/pid.tsï¼‰

PIDãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ï¼š
```typescript
interface PidFileContent {
  pid: number;
  startedAt: string;  // ISO 8601
  port: number;
  configPath: string;
  logPath?: string;
}
```

ä¿å­˜å ´æ‰€: `.search-docs/server.pid`

## æ®‹èª²é¡Œ

### å„ªå…ˆåº¦: ä¸­
1. **index statusã®å®Ÿè£…**
   - ã‚µãƒ¼ãƒã®getStatus APIã‚’å‘¼ã³å‡ºã—
   - ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹çµ±è¨ˆã‚’è¡¨ç¤º
   - æ¨å®šå·¥æ•°: 1æ™‚é–“

2. **index cleanã®å®Ÿè£…**
   - Dirtyã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å¼·åˆ¶ã‚¯ãƒªãƒ¼ãƒ³
   - rebuildIndex APIã‚’åˆ©ç”¨
   - æ¨å®šå·¥æ•°: 1æ™‚é–“

### å„ªå…ˆåº¦: ä½
3. **config initã®å®Ÿè£…**
   - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ
   - æ¨å®šå·¥æ•°: 2æ™‚é–“

4. **config validateã®å®Ÿè£…**
   - è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
   - æ¨å®šå·¥æ•°: 1.5æ™‚é–“

5. **config showã®å®Ÿè£…**
   - è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’è¡¨ç¤º
   - æ¨å®šå·¥æ•°: 0.5æ™‚é–“

## æŠ€è¡“çš„ãƒã‚¤ãƒ©ã‚¤ãƒˆ

### ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ å¯¾å¿œ
- Node.jsæ¨™æº–APIã‚’ä½¿ç”¨ã—ã¦ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ä¾å­˜æ€§ã‚’æœ€å°åŒ–
- Windows/Mac/Linuxã§å‹•ä½œç¢ºèª

### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- ä¸å¯§ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
- çµ‚äº†ã‚³ãƒ¼ãƒ‰: 0ï¼ˆæˆåŠŸï¼‰ã€1ï¼ˆã‚¨ãƒ©ãƒ¼ï¼‰
- ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã¯å¿…è¦ã«å¿œã˜ã¦è¡¨ç¤º

### ãƒ—ãƒ­ã‚»ã‚¹ç®¡ç†ã®å·¥å¤«
- SIGTERM â†’ SIGKILL ã®ã‚°ãƒ¬ãƒ¼ã‚¹ãƒ•ãƒ«åœæ­¢
- PIDãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚ˆã‚‹ãƒ—ãƒ­ã‚»ã‚¹è¿½è·¡
- æ—¢å­˜ãƒ—ãƒ­ã‚»ã‚¹ã®æ¤œå‡ºã¨è­¦å‘Š

## é–¢é€£ã‚³ãƒŸãƒƒãƒˆ

ä¸»è¦ãªã‚³ãƒŸãƒƒãƒˆï¼š
- `d872de8` - feat(cli): index rebuildã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè£…
- `d20d93f` - refactor(cli): dist/srcæ§‹é€ ã‚’è§£æ¶ˆã—ã¦dist/ç›´ä¸‹ã«å‡ºåŠ›

## æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

Task4ã¯**Phase 3ï¼ˆserverã‚³ãƒãƒ³ãƒ‰ï¼‰ãŒå®Œå…¨ã«å®Œäº†**ã—ãŸãŸã‚ã€å®Ÿç”¨ä¸Šã¯ååˆ†ã«æ©Ÿèƒ½ã—ã¦ã„ã¾ã™ã€‚

æ®‹ã‚Šã®æœªå®Ÿè£…ã‚³ãƒãƒ³ãƒ‰ã¯ã€å¿…è¦ã«å¿œã˜ã¦åˆ¥ã‚¿ã‚¹ã‚¯ã¨ã—ã¦å®Ÿè£…ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ï¼š

1. **Task 8å€™è£œ**: index status/clean ã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè£…
2. **Task 9å€™è£œ**: config init/validate/show ã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè£…

ã¾ãŸã¯ã€ã“ã‚Œã‚‰ã¯ä½å„ªå…ˆåº¦ã¨ã—ã¦ã€ä»–ã®é‡è¦ã‚¿ã‚¹ã‚¯ï¼ˆTask 6ã®è¨­è¨ˆä¹–é›¢å•é¡Œã€Task 7ã®æ¤œè¨¼ä½œæ¥­ãªã©ï¼‰ã‚’å„ªå…ˆã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã€‚

## ã¾ã¨ã‚

**Task 4ã®ä¸»è¦ç›®çš„ã§ã‚ã‚‹serverã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè£…ã¯å®Œäº†**ã—ã¾ã—ãŸã€‚

- âœ… **å®Œäº†**: Phase 3ï¼ˆserverã‚³ãƒãƒ³ãƒ‰ï¼‰
- âš ï¸ **éƒ¨åˆ†å®Œäº†**: Phase 4ï¼ˆindexã‚³ãƒãƒ³ãƒ‰ - rebuildã®ã¿ï¼‰
- âŒ **æœªå®Ÿè£…**: Phase 5ï¼ˆconfigã‚³ãƒãƒ³ãƒ‰ï¼‰

search-docsã®åŸºæœ¬çš„ãªé‹ç”¨ï¼ˆã‚µãƒ¼ãƒèµ·å‹•ãƒ»åœæ­¢ãƒ»æ¤œç´¢ãƒ»ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å†æ§‹ç¯‰ï¼‰ã¯å¯èƒ½ãªçŠ¶æ…‹ã§ã™ã€‚

---

**æœ€çµ‚æ›´æ–°**: 2025-10-30
**çŠ¶æ…‹**: Phase 3å®Œäº†ã€Phase 4/5ã¯åˆ¥ã‚¿ã‚¹ã‚¯ã¨ã—ã¦åˆ‡ã‚Šå‡ºã—æ¨å¥¨
**é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«**:
- task4.cli-remaining-commands.v1.mdï¼ˆè¨ˆç”»æ›¸ï¼‰
- packages/cli/src/commands/server/ï¼ˆå®Ÿè£…ï¼‰
- packages/cli/src/commands/index/rebuild.tsï¼ˆå®Ÿè£…ï¼‰
- packages/cli/src/index.tsï¼ˆã‚³ãƒãƒ³ãƒ‰å®šç¾©ï¼‰
